<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">

    <title>Warp Chat</title>

</head>

<body>

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
            <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js" integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT" crossorigin="anonymous"></script>
            -->

    <nav class="navbar navbar-light" style="background-color: #563d7c;">
        <span class="navbar-brand mb-0 h1" style="color: white; padding-left: 1rem;">狼人杀信息发送</span>
    </nav>

    <div style="margin-left: 1em">
        <div id="chat">
            <p><em>Connecting...</em></p>
        </div>
        <input type="text" id="text" />
        <button type="button" class="btn btn-primary" id="send">Send</button>
    </div>
    <script type="text/javascript">
        const chat = document.getElementById('chat');
        const text = document.getElementById('text');
        const uri = 'ws://' + location.hostname + ':3030/chat';
        const ws = new WebSocket(uri);
        const storage = window.sessionStorage;

        console.log('current storage data', storage);

        function message(data) {
            const line = document.createElement('p');
            line.innerText = data;
            chat.appendChild(line);
            chat.appendChild(document.createElement('hr'));
        }

        ws.onopen = function () {
            chat.innerHTML = '<p><em>Connected!</em></p>';
            let number = storage.getItem('number');
            console.log("number: ", number);
            if (number) {
                ws.send("number: " + storage.getItem('number'));
                console.log("send number to backend: " + number);
            } 
        };

        ws.onmessage = function (msg) {
            console.log('receive msg: ', msg.data);
            let str = String(msg.data);
            if (str === "clean") {
                console.log("receive backend clean request");
                storage.clear();
            }
            if (str.length < 12 && !storage.getItem('number') && str.startsWith("你的号码是")) {
                console.log("update number");
                storage.setItem('number', str.split("你的号码是")[1]);
            }
            message(msg.data);
        };

        ws.onclose = function () {
            chat.getElementsByTagName('em')[0].innerText = 'Disconnected!';
        };

        send.onclick = function () {
            const msg = text.value;
            ws.send(msg);
            text.value = '';
            message('<You>: ' + msg);
        };

    </script>
</body>

</html>
